<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<link rel="icon" type="image/png" href="themes/favicon.png">
<title>SmallRye Health in Quarkus</title>
<style>
/* General Styles */
body {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: 12pt;
    line-height: 1.5;
    color: #333;
    margin: 2cm;
}

/* Regel für Linie VOR einer Abschnittsüberschrift */
h1, h2, h3, h4, h5, h6 {
    margin-top: 1em; /* Optional: Abstand oberhalb der Linie */
    border-top: 1px solid #ccc; /* Linie oberhalb der Abschnittsüberschrift */
    padding-top: 0.3em; /* Optional: Abstand zwischen Linie und Text */
    color: #2c3e50;
    margin-bottom: 0.5em;
}

h1:first-of-type, h2:first-of-type, h3:first-of-type,
h4:first-of-type, h5:first-of-type, h6:first-of-type {
    border-top: none; /* Keine Linie vor der ersten Abschnittsüberschrift */
}

h1 {
    font-size: 24pt;
}

h2 {
    font-size: 18pt;
}

h3 {
    font-size: 16pt;
}

h4 {
    font-size: 14pt;
}

h5 {
    font-size: 12pt;
}

h6 {
    font-size: 11pt;
}

p {
    margin: 0.5em 0;
}

ul, ol {
    margin: 0.5em 0;
    padding: 0 1em;
}

/* Code Block Styling */
pre {
    font-family: 'Courier New', Courier, monospace;
    background-color: #f2f2f2;
    padding: 0.5em;
    border-left: 3px solid #3498db;
    margin: 1em 0;
}

code {
    font-family: 'Courier New', Courier, monospace;
    background-color: #f2f2f2;
    padding: 0.2em 0.4em;
    border-radius: 3px;
}

/* Table Styling */
table {
    width: 100%;
    border-collapse: collapse;
    margin: 1em 0;
}

th, td {
    padding: 0.5em;
    text-align: left;
    border: 1px solid #ccc;
}

th {
    background-color: #f2f2f2;
}

/* Blockquote Styling */
blockquote {
    margin: 1em 0;
    padding: 0.5em 10px;
    color: #666;
    border-left: 3px solid #bdc3c7;
    background-color: #ecf0f1;
}

/* Admonition Styling */
.admonitionblock td.icon {
    background-color: #f9f9f9;
    border-color: #e1e1e1;
}

.admonitionblock td.icon .title {
    color: #333;
}

.admonitionblock td.content {
    border-color: #e1e1e1;
}

.admonitionblock td.icon,
.admonitionblock td.icon .title {
    color: #333;
}

.admonitionblock td.icon.warning,
.admonitionblock td.icon.warning .title {
    background-color: #fcf8e3;
    border-color: #faebcc;
    color: #8a6d3b;
}

.admonitionblock td.icon.error,
.admonitionblock td.icon.error .title {
    background-color: #f2dede;
    border-color: #ebccd1;
}


/* General Styles */
body {
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-size: 12pt;
    line-height: 1.5;
    color: #333;
    margin: 2cm;
    position: relative; /* Position relativ für die absolute Positionierung der Linie */
}

/* Linie vor == Abschnittsüberschriften */
h1, h2, h3, h4, h5, h6 {
    position: relative; /* Position relativ für die absolute Positionierung der Linie */
}

h2::before, img::before {
    content: '';
    display: block;
    position: absolute;
    top: -1px; /* Position oben über der Abschnittsüberschrift */
    left: 0;
    width: 100%;
    height: 1px; /* Höhe der Linie */
    background-color: #000; /* Schwarze Linie */
}
/*
color: #a94442;
}*/
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge, pre.rouge .w {
  color: #24292f;
  background-color: #f6f8fa;
}
pre.rouge .k, pre.rouge .kd, pre.rouge .kn, pre.rouge .kp, pre.rouge .kr, pre.rouge .kt, pre.rouge .kv {
  color: #cf222e;
}
pre.rouge .gr {
  color: #f6f8fa;
}
pre.rouge .gd {
  color: #82071e;
  background-color: #ffebe9;
}
pre.rouge .nb {
  color: #953800;
}
pre.rouge .nc {
  color: #953800;
}
pre.rouge .no {
  color: #953800;
}
pre.rouge .nn {
  color: #953800;
}
pre.rouge .sr {
  color: #116329;
}
pre.rouge .na {
  color: #116329;
}
pre.rouge .nt {
  color: #116329;
}
pre.rouge .gi {
  color: #116329;
  background-color: #dafbe1;
}
pre.rouge .kc {
  color: #0550ae;
}
pre.rouge .l, pre.rouge .ld, pre.rouge .m, pre.rouge .mb, pre.rouge .mf, pre.rouge .mh, pre.rouge .mi, pre.rouge .il, pre.rouge .mo, pre.rouge .mx {
  color: #0550ae;
}
pre.rouge .sb {
  color: #0550ae;
}
pre.rouge .bp {
  color: #0550ae;
}
pre.rouge .ne {
  color: #0550ae;
}
pre.rouge .nl {
  color: #0550ae;
}
pre.rouge .py {
  color: #0550ae;
}
pre.rouge .nv, pre.rouge .vc, pre.rouge .vg, pre.rouge .vi, pre.rouge .vm {
  color: #0550ae;
}
pre.rouge .o, pre.rouge .ow {
  color: #0550ae;
}
pre.rouge .gh {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .gu {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .sc, pre.rouge .dl, pre.rouge .sd, pre.rouge .s2, pre.rouge .se, pre.rouge .sh, pre.rouge .sx, pre.rouge .s1, pre.rouge .ss {
  color: #0a3069;
}
pre.rouge .nd {
  color: #8250df;
}
pre.rouge .nf, pre.rouge .fm {
  color: #8250df;
}
pre.rouge .err {
  color: #f6f8fa;
  background-color: #82071e;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cm, pre.rouge .cp, pre.rouge .cpf, pre.rouge .c1, pre.rouge .cs {
  color: #6e7781;
}
pre.rouge .gl {
  color: #6e7781;
}
pre.rouge .gt {
  color: #6e7781;
}
pre.rouge .ni {
  color: #24292f;
}
pre.rouge .si {
  color: #24292f;
}
pre.rouge .ge {
  color: #24292f;
  font-style: italic;
}
pre.rouge .gs {
  color: #24292f;
  font-weight: bold;
}
</style>
<style>
    pre.rouge .hll {
        background-color: #ffc;
        display: block;
    }
    pre.rouge .hll * {
        background-color: initial;
    }
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>SmallRye Health in Quarkus</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_prerequisites">1. Prerequisites</a></li>
<li><a href="#_creating_the_maven_project">2. Creating the Maven Project</a>
<ul class="sectlevel2">
<li><a href="#_smallrye_health_extension">2.1. SmallRye Health extension</a></li>
</ul>
</li>
<li><a href="#_first_attempts_with_existing_health_checks_endpoints">3. First attempts with existing health checks endpoints</a>
<ul class="sectlevel2">
<li><a href="#_start_the_project">3.1. Start the project</a></li>
<li><a href="#_use_existing_health_checks_endpoints">3.2. Use existing health checks endpoints</a></li>
</ul>
</li>
<li><a href="#_individual_health_checks">4. Individual Health Checks</a>
<ul class="sectlevel2">
<li><a href="#_liveness_check">4.1. Liveness-Check</a></li>
<li><a href="#_readiness_check">4.2. Readiness-Check</a></li>
<li><a href="#_startup_check">4.3. Startup-Check</a></li>
</ul>
</li>
<li><a href="#_individual_health_check_example_with_database_connection">5. Individual Health Check: Example with Database connection</a>
<ul class="sectlevel2">
<li><a href="#_database_setup">5.1. Database Setup</a></li>
<li><a href="#_prepare_quarkus_application_for_database_usage">5.2. Prepare Quarkus application for database usage</a></li>
<li><a href="#_create_the_health_check_for_the_database_connection">5.3. Create the health check for the database connection</a></li>
<li><a href="#_launch_the_application_and_watch_the_results">5.4. Launch the application and watch the results</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>SmallRye Health allows applications to provide information about their state to external viewers which is typically useful in cloud environments where automated processes must be able to determine whether the application should be discarded or restarted.</p>
</div>
<div class="paragraph">
<p><strong>In this instruction, I will show you how to use it in Quarkus.</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>1. Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Roughly 15 minutes</p>
</li>
<li>
<p>An IDE</p>
</li>
<li>
<p>JDK 17+ installed with JAVA_HOME configured appropriately</p>
</li>
<li>
<p>Apache Maven 3.9.8</p>
</li>
<li>
<p>Optionally the Quarkus CLI if you want to use it</p>
</li>
<li>
<p>Optionally Mandrel or GraalVM installed and configured appropriately if you want to build a native executable (or Docker if you use a native container build)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_the_maven_project"><a class="anchor" href="#_creating_the_maven_project"></a>2. Creating the Maven Project</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/create-project.png" alt="create project">
</div>
</div>
<div class="sect2">
<h3 id="_smallrye_health_extension"><a class="anchor" href="#_smallrye_health_extension"></a>2.1. SmallRye Health extension</h3>
<div class="ulist">
<ul>
<li>
<p><em>in Wizard:</em></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/required-extensions.png" alt="required extensions">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><em>or add to existing project:</em></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Quarkus-CLI</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">quarkus ext add io.quarkus:quarkus-smallrye-health</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Maven-Wrapper</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw quarkus:add-extension <span class="nt">-Dextensions</span><span class="o">=</span><span class="s2">"io.quarkus:quarkus-smallrye-health"</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.quarkus<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>quarkus-smallrye-health<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_first_attempts_with_existing_health_checks_endpoints"><a class="anchor" href="#_first_attempts_with_existing_health_checks_endpoints"></a>3. First attempts with existing health checks endpoints</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_start_the_project"><a class="anchor" href="#_start_the_project"></a>3.1. Start the project</h3>
<div class="listingblock">
<div class="title">Quarkus-CLI</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">quarkus dev <span class="nt">--clean</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Maven-Wrapper</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw clean quarkus:dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Importing the smallrye-health extension directly exposes three REST endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="localhost:8080/q/health/live"><code>/q/health/live</code></a> - The application is up and running.</p>
</li>
<li>
<p><a href="localhost:8080/q/health/ready"><code>/q/health/ready</code></a> - The application is ready to serve requests.</p>
</li>
<li>
<p><a href="localhost:8080/q/health/started"><code>/q/health/started</code></a> - The application is started.</p>
</li>
<li>
<p><a href="localhost:8080/q/health"><code>/q/health</code></a> - Accumulating all health check procedures in the application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All health REST endpoints return a simple JSON object with two fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>status</code> - the overall result of all the health check procedures</p>
<div class="ulist">
<ul>
<li>
<p><code>UP</code> - all checks are up</p>
</li>
<li>
<p><code>DOWN</code> - one or more checks are down</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>checks</code> - an array of individual checks</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_use_existing_health_checks_endpoints"><a class="anchor" href="#_use_existing_health_checks_endpoints"></a>3.2. Use existing health checks endpoints</h3>
<div class="listingblock">
<div class="title">Example: Accumulating all health check procedures in the application</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl http://localhost:8080/q/health</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Response of /q/health/live</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UP"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"checks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Now try it yourself with the other existing endpoints :-)</strong></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_individual_health_checks"><a class="anchor" href="#_individual_health_checks"></a>4. Individual Health Checks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can also create your own health checks to announce the availability of your own program parts using own health check classes.</p>
</div>
<div class="sect2">
<h3 id="_liveness_check"><a class="anchor" href="#_liveness_check"></a>4.1. Liveness-Check</h3>
<div class="paragraph">
<p>These checks appear in the endpoint <code>/q/health/live</code></p>
</div>
<div class="sect3">
<h4 id="_create_class_livenesscheck"><a class="anchor" href="#_create_class_livenesscheck"></a>4.1.1. Create class <code>LivenessCheck</code></h4>
<div class="imageblock">
<div class="content">
<img src="images/create-class-livenesscheck.png" alt="create class livenesscheck">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implement_class_livenesscheck"><a class="anchor" href="#_implement_class_livenesscheck"></a>4.1.2. Implement class <code>LivenessCheck</code></h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">at.htlleonding.health</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.microprofile.health.HealthCheck</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.microprofile.health.HealthCheckResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.microprofile.health.Liveness</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="nd">@Liveness</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@ApplicationScoped</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LivenessCheck</span> <span class="kd">implements</span> <span class="nc">HealthCheck</span> <span class="o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">HealthCheckResponse</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">isUp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextBoolean</span><span class="o">();</span> <i class="conum" data-value="4"></i><b>(4)</b>

        <span class="k">if</span><span class="o">(</span><span class="n">isUp</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="5"></i><b>(5)</b>
            <span class="k">return</span> <span class="nc">HealthCheckResponse</span><span class="o">.</span><span class="na">up</span><span class="o">(</span><span class="s">"liveness-check"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">HealthCheckResponse</span><span class="o">.</span><span class="na">down</span><span class="o">(</span><span class="s">"liveness-check"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@Liveness</code> annotation means that the check is a Liveness-Check and exposes the result on <code>/q/health/live</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It’s recommended to annotate the health check class with <code>@ApplicationScoped</code> so that a single bean instance is used for all health check requests.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Your health check class needs to implement the <code>HealthCheck</code> interface. This means you have to override the <code>call</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This is the condition whether the check is up or down. Here in the demo example we use a random boolean</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Here you return the name of your health check with <code>HealthCheckResponse.up</code> or <code>HealthCheckResponse.down</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_get_response_of_livenesscheck"><a class="anchor" href="#_get_response_of_livenesscheck"></a>4.1.3. Get response of LivenessCheck</h4>
<div class="listingblock">
<div class="title">Accumulating liveness health check procedures in the application</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl http://localhost:8080/q/health/live</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Response of /q/health/live</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DOWN"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"checks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"liveness-check"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DOWN"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_readiness_check"><a class="anchor" href="#_readiness_check"></a>4.2. Readiness-Check</h3>
<div class="paragraph">
<p>These checks appear in the endpoint <code>/q/health/ready</code></p>
</div>
<div class="sect3">
<h4 id="_create_class_readinesscheck"><a class="anchor" href="#_create_class_readinesscheck"></a>4.2.1. Create class <code>ReadinessCheck</code></h4>
<div class="imageblock">
<div class="content">
<img src="images/create-class-readinesscheck.png" alt="create class readinesscheck">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implement_class_readinesscheck"><a class="anchor" href="#_implement_class_readinesscheck"></a>4.2.2. Implement class <code>ReadinessCheck</code></h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">at.htlleonding.health</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.microprofile.health.HealthCheck</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.microprofile.health.HealthCheckResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.microprofile.health.Readiness</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="nd">@Readiness</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@ApplicationScoped</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReadinessCheck</span> <span class="kd">implements</span> <span class="nc">HealthCheck</span> <span class="o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">HealthCheckResponse</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">isUp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextBoolean</span><span class="o">();</span> <i class="conum" data-value="4"></i><b>(4)</b>

        <span class="k">if</span><span class="o">(</span><span class="n">isUp</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="5"></i><b>(5)</b>
            <span class="k">return</span> <span class="nc">HealthCheckResponse</span><span class="o">.</span><span class="na">up</span><span class="o">(</span><span class="s">"readiness-check"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">HealthCheckResponse</span><span class="o">.</span><span class="na">down</span><span class="o">(</span><span class="s">"readiness-check"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@Readiness</code> annotation means that the check is a Readiness-Check and exposes the result on <code>/q/health/ready</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It’s recommended to annotate the health check class with <code>@ApplicationScoped</code> so that a single bean instance is used for all health check requests.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Your health check class needs to implement the <code>HealthCheck</code> interface. This means you have to override the <code>call</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This is the condition whether the check is up or down. Here in the demo example we use a random boolean.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Here you return the name of your health check with <code>HealthCheckResponse.up</code> or <code>HealthCheckResponse.down</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_get_response_of_readinesscheck"><a class="anchor" href="#_get_response_of_readinesscheck"></a>4.2.3. Get response of ReadinessCheck</h4>
<div class="listingblock">
<div class="title">Accumulating readiness health check procedures in the application</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl http://localhost:8080/q/health/ready</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Response of /q/health/ready</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DOWN"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"checks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"readiness-check"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DOWN"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_startup_check"><a class="anchor" href="#_startup_check"></a>4.3. Startup-Check</h3>
<div class="paragraph">
<p>These checks appear in the endpoint <code>/q/health/started</code></p>
</div>
<div class="sect3">
<h4 id="_create_class_startupcheck"><a class="anchor" href="#_create_class_startupcheck"></a>4.3.1. Create class <code>StartupCheck</code></h4>
<div class="imageblock">
<div class="content">
<img src="images/create-class-startupcheck.png" alt="create class startupcheck">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implement_class_startupcheck"><a class="anchor" href="#_implement_class_startupcheck"></a>4.3.2. Implement class <code>StartupCheck</code></h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">at.htlleonding.health</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.microprofile.health.HealthCheck</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.microprofile.health.HealthCheckResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.microprofile.health.Startup</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="nd">@Startup</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@ApplicationScoped</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StartupCheck</span> <span class="kd">implements</span> <span class="nc">HealthCheck</span> <span class="o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">HealthCheckResponse</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">isUp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextBoolean</span><span class="o">();</span> <i class="conum" data-value="4"></i><b>(4)</b>

        <span class="k">if</span><span class="o">(</span><span class="n">isUp</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="5"></i><b>(5)</b>
            <span class="k">return</span> <span class="nc">HealthCheckResponse</span><span class="o">.</span><span class="na">up</span><span class="o">(</span><span class="s">"startup-check"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">HealthCheckResponse</span><span class="o">.</span><span class="na">down</span><span class="o">(</span><span class="s">"startup-check"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@Startup</code> annotation means that the check is a Startup-Check and exposes the result on <code>/q/health/started</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It’s recommended to annotate the health check class with <code>@ApplicationScoped</code> so that a single bean instance is used for all health check requests.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Your health check class needs to implement the <code>HealthCheck</code> interface. This means you have to override the <code>call</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This is the condition whether the check is up or down. Here in the demo example we use a random boolean.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Here you return the name of your health check with <code>HealthCheckResponse.up</code> or <code>HealthCheckResponse.down</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_get_response_of_readinesscheck_2"><a class="anchor" href="#_get_response_of_readinesscheck_2"></a>4.3.3. Get response of ReadinessCheck</h4>
<div class="listingblock">
<div class="title">Accumulating startup health check procedures in the application</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl http://localhost:8080/q/health/started</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Response of /q/health/started</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UP"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"checks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"startup-check"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UP"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_individual_health_check_example_with_database_connection"><a class="anchor" href="#_individual_health_check_example_with_database_connection"></a>5. Individual Health Check: Example with Database connection</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Stop the Quarkus application to avoid any problems.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_database_setup"><a class="anchor" href="#_database_setup"></a>5.1. Database Setup</h3>
<div class="ulist">
<ul>
<li>
<p>run the following script to start a PostgreSQL database in Docker</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker run <span class="nt">--rm</span> <span class="se">\</span>
           <span class="nt">--name</span> postgres-db <span class="se">\</span>
           <span class="nt">-e</span> <span class="nv">POSTGRES_USER</span><span class="o">=</span>app <span class="se">\</span>
           <span class="nt">-e</span> <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span>app <span class="se">\</span>
           <span class="nt">-e</span> <span class="nv">POSTGRES_DB</span><span class="o">=</span>db <span class="se">\</span>
           <span class="nt">-v</span> <span class="k">${</span><span class="nv">PWD</span><span class="k">}</span>/db-postgres/db:/var/lib/postgresql/data <span class="se">\</span>
           <span class="nt">-p</span> 5432:5432 <span class="se">\</span>
           postgres:16.3-alpine</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>or use <a href="https://edufs.edu.htl-leonding.ac.at/~t.stuetz/download/nvs/scripts/postgres-16.3/postgres-run-in-docker.sh">this</a> download link and run the script with</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">chmod </span>u+x postgres-run-in-docker.sh
./postgres-run-in-docker.sh</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_prepare_quarkus_application_for_database_usage"><a class="anchor" href="#_prepare_quarkus_application_for_database_usage"></a>5.2. Prepare Quarkus application for database usage</h3>
<div class="ulist">
<ul>
<li>
<p>paste following properties for the PostgreSQL database connection in your application.properties in the Quarkus project</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">application.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="c"># datasource configuration
</span><span class="py">quarkus.datasource.db-kind</span> <span class="p">=</span> <span class="s">postgresql</span>
<span class="py">quarkus.datasource.username</span> <span class="p">=</span> <span class="s">app</span>
<span class="py">quarkus.datasource.password</span> <span class="p">=</span> <span class="s">app</span>
<span class="py">quarkus.datasource.jdbc.url</span> <span class="p">=</span> <span class="s">jdbc:postgresql://localhost:5432/db</span>

<span class="c"># drop and create the database at startup (use `update` to only update the schema)
</span><span class="py">quarkus.hibernate-orm.database.generation</span><span class="p">=</span><span class="s">drop-and-create</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>if you use a GitHub-Repository, add following clause to your .gitignore, to exclude all database files</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="gitignore">**/db-postgres/</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>add dependencies for the database connection (JDBC, Hibernate, Panache)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Quarkus-CLI</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">quarkus ext add io.quarkus:quarkus-jdbc-postgresql
quarkus ext add io.quarkus:quarkus-hibernate-orm-rest-data-panache</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Maven-Wrapper</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw quarkus:add-extension <span class="nt">-Dextensions</span><span class="o">=</span><span class="s2">"io.quarkus:quarkus-jdbc-postgresql"</span>
./mvnw quarkus:add-extension <span class="nt">-Dextensions</span><span class="o">=</span><span class="s2">"io.quarkus:quarkus-hibernate-orm-rest-data-panache"</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>or paste following dependency snippets to your <code>pom.xml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.quarkus<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>quarkus-jdbc-postgresql<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.quarkus<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>quarkus-hibernate-orm-rest-data-panache<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_the_health_check_for_the_database_connection"><a class="anchor" href="#_create_the_health_check_for_the_database_connection"></a>5.3. Create the health check for the database connection</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Unfortunately, JPA/Hibernate and Panache do not have any pre-programmed functions to determine the availability of the database. Therefore, we send a simple native query to the database (SELECT 1) to test whether the connection exists.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_create_class_databasehealthcheck"><a class="anchor" href="#_create_class_databasehealthcheck"></a>5.3.1. Create class <code>DatabaseHealthCheck</code></h4>
<div class="imageblock">
<div class="content">
<img src="images/create-class-databasehealthcheck.png" alt="create class databasehealthcheck">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implement_class_databasehealthcheck"><a class="anchor" href="#_implement_class_databasehealthcheck"></a>5.3.2. Implement class <code>DatabaseHealthCheck</code></h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">at.htlleonding.health</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.microprofile.health.HealthCheck</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.microprofile.health.HealthCheckResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.eclipse.microprofile.health.Readiness</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.sql.DataSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.sql.Connection</span><span class="o">;</span>

<span class="nd">@Readiness</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@ApplicationScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DatabaseHealthCheck</span> <span class="kd">implements</span> <span class="nc">HealthCheck</span> <span class="o">{</span>
    <span class="nd">@Inject</span>
    <span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">;</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">HealthCheckResponse</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span><span class="o">(</span><span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">dataSource</span><span class="o">.</span><span class="na">getConnection</span><span class="o">())</span> <span class="o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="k">if</span><span class="o">(!</span><span class="n">connection</span><span class="o">.</span><span class="na">isValid</span><span class="o">(</span><span class="mi">2</span><span class="o">)){</span> <i class="conum" data-value="4"></i><b>(4)</b>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">"invalid connection after calling connection.isValid with a timeout of 2s"</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="nc">HealthCheckResponse</span><span class="o">.</span><span class="na">up</span><span class="o">(</span><span class="s">"database-connection-active"</span><span class="o">);</span> <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">HealthCheckResponse</span><span class="o">.</span><span class="na">down</span><span class="o">(</span><span class="s">"database-connection-active"</span><span class="o">);</span> <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>1: for database checks, we use Readiness-Checks
2: the existing configured database connection will be injected in this variable (java.sql.Datasource dataSource)
3: we try to get the connection
4: then it will be checked if the connection is valid
5: if everything works, it returns a <code>HealthCheckResponse.up</code> with <code>database-connection-active</code> as name
6: if something fails, it returns a <code>HealthCheckResponse.down</code> with <code>database-connection-active</code> as name</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_launch_the_application_and_watch_the_results"><a class="anchor" href="#_launch_the_application_and_watch_the_results"></a>5.4. Launch the application and watch the results</h3>
<div class="listingblock">
<div class="title">Quarkus-CLI</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">quarkus dev <span class="nt">--clean</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Maven-Wrapper</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw clean quarkus:dev</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_explore_the_results"><a class="anchor" href="#_explore_the_results"></a>5.4.1. Explore the results</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl http://localhost:8080/q/health/ready</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DOWN"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"checks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Database connections health check"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DOWN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"&lt;default&gt;"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Unable to execute the validation check for the default DataSource: Connection to localhost:5432 refused. Check that the hostname and port are correct and that the postmaster is accepting TCP/IP connections."</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"database-connection-active"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DOWN"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"readiness-check"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DOWN"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Surprisingly, in addition to our own implemented database check, there is already a pre-implemented database check by SmallRye
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-10-21 10:43:23 UTC
</div>
</div>
</body>
</html>